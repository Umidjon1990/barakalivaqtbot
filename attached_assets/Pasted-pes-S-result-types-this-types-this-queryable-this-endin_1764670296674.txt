pes&&(S._result._types=this._types),this._queryable?this._ending?(de.nextTick(()=>{S.handleError(new Error("Client was closed and is not queryable"),this.connection)}),_):(this.queryQueue.push(S),this._pulseQueryQueue(),_):(de.nextTick(()=>{S.handleError(new Error("Client has encountered a connection error and is not queryable"),this.connection)}),_)}ref(){this.connection.ref()}unref(){this.connection.unref()}end(p){if(this._ending=!0,!this.connection._connecting)if(p)p();else return this._Promise.resolve();if(this.activeQuery||!this._queryable?this.connection.stream.destroy():this.connection.end(),p)this.connection.once("end",p);else return new this._Promise(y=>{this.connection.once("end",y)})}};x(m,"Client");var g=m;g.Query=l,e.exports=g}),KI=fe((t,e)=>{"use strict";te();var r=Kn().EventEmitter,n=x(function(){},"NOOP"),i=x((h,p)=>{let y=h.findIndex(p);return y===-1?void 0:h.splice(y,1)[0]},"removeWhere"),a=class{constructor(p,y,w){this.client=p,this.idleListener=y,this.timeoutId=w}};x(a,"IdleItem");var s=a,o=class{constructor(p){this.callback=p}};x(o,"PendingItem");var c=o;function l(){throw new Error("Release called on client which has already been released to the pool.")}x(l,"throwOnDoubleRelease");function u(h,p){if(p)return{callback:p,result:void 0};let y,w,S=x(function(O,q){O?y(O):w(q)},"cb"),_=new h(function(O,q){w=O,y=q}).catch(O=>{throw Error.captureStackTrace(O),O});return{callback:S,result:_}}x(u,"promisify");function d(h,p){return x(function y(w){w.client=p,p.removeListener("error",y),p.on("error",()=>{h.log("additional client error after disconnection due to error",w)}),h._remove(p),h.emit("error",w,p)},"idleListener")}x(d,"makeIdleListener");var m=class extends r{constructor(p,y){super(),this.options=Object.assign({},p),p!=null&&"password"in p&&Object.defineProperty(this.options,"password",{configurable:!0,enumerable:!1,writable:!0,value:p.password}),p!=null&&p.ssl&&p.ssl.key&&Object.defineProperty(this.options.ssl,"key",{enumerable:!1}),this.options.max=this.options.max||this.options.poolSize||10,this.options.maxUses=this.options.maxUses||1/0,this.options.allowExitOnIdle=this.options.allowExitOnIdle||!1,this.options.maxLifetimeSeconds=this.options.maxLifetimeSeconds||0,this.log=this.options.log||function(){},this.Client=this.options.Client||y||Pf().Client,this.Promise=this.options.Promise||Mc.Promise,typeof this.options.idleTimeoutMillis>"u"&&(this.options.idleTimeoutMillis=1e4),this._clients=[],this._idle=[],this._expired=new WeakSet,this._pendingQueue=[],this._endCallback=void 0,this.ending=!1,this.ended=!1}_isFull(){return this._clients.length>=this.options.max}_pulseQueue(){if(this.log("pulse queue"),this.ended){this.log("pulse queue ended");return}if(this.ending){this.log("pulse queue on ending"),this._idle.length&&this._idle.slice().map(y=>{this._remove(y.client)}),this._clients.length||(this.ended=!0,this._endCallback());return}if(!this._pendingQueue.length){this.log("no queued requests");return}if(!this._idle.length&&this._isFull())return;let p=this._pendingQueue.shift();if(this._idle.length){let y=this._idle.pop();clearTimeout(y.timeoutId);let w=y.client;w.ref&&w.ref();let S=y.idleListener;return this._acquireClient(w,p,S,!1)}if(!this._isFull())return this.newClient(p);throw new Error("unexpected condition")}_remove(p){let y=i(this._idle,w=>w.client===p);y!==void 0&&clearTimeout(y.timeoutId),this._clients=this._clients.filter(w=>w!==p),p.end(),this.emit("remove",p)}connect(p){if(this.ending){let S=new Error("Cannot use a pool after calling end on the pool");return p?p(S):this.Promise.reject(S)}let y=u(this.Promise,p),w=y.result;if(this._isFull()||this._idle.length){if(this._idle.length&&de.nextTick(()=>this._pulseQueue()),!this.options.connectionTimeoutMillis)return this._pendingQueue.push(new c(y.callback)),w;let S=x((q,k,A)=>{clearTimeout(O),y.callback(q,k,A)},"queueCallback"),_=new c(S),O=setTimeout(()=>{i(this._pendingQueue,q=>q.callback===S),_.timedOut=!0,y.callback(new Error("timeout exceeded when trying to connect"))},this.options.connectionTimeoutMillis);return this._pendingQueue.push(_),w}return this.newClient(new c(y.callback)),w}newClient(p){let y=new this.Client(this.options);this._clients.push(y);let w=d(this,y);this.log("checking client timeout");let S,_=!1;this.options.connectionTimeoutMillis&&(S=setTimeout(()=>{this.log("ending client due to timeout"),_=!0,y.connection?y.connection.stream.destroy():y.end()},this.options.connectionTimeoutMillis)),this.log("connecting new client"),y.connect(O=>{if(S&&clearTimeout(S),y.on("error",w),O)this.log("client failed to connect",O),this._clients=this._clients.filter(q=>q!==y),_&&(O.message="Connection terminated due to connection timeout"),this._pulseQueue(),p.timedOut||p.callback(O,void 0,n);else{if(this.log("new client connected"),this.options.maxLifetimeSeconds!==0){let q=setTimeout(()=>{this.log("ending client due to expired lifetime"),this._expired.add(y),this._idle.findIndex(k=>k.client===y)!==-1&&this._acquireClient(y,new c((k,A,I)=>I()),w,!1)},this.options.maxLifetimeSeconds*1e3);q.unref(),y.once("end",()=>clearTimeout(q))}return this._acquireClient(y,p,w,!0)}})}_acquireClient(p,y,w,S){S&&this.emit("connect",p),this.emit("acquire",p),p.release=this._releaseOnce(p,w),p.removeListener("error",w),y.timedOut?S&&this.options.verify?this.options.verify(p,p.release):p.release():S&&this.options.verify?this.options.verify(p,_=>{if(_)return p.release(_),y.callback(_,void 0,n);y.callback(void 0,p,p.release)}):y.callback(void 0,p,p.release)}_releaseOnce(p,y){let w=!1;return S=>{w&&l(),w=!0,this._release(p,y,S)}}_release(p,y,w){if(p.on("error",y),p._poolUseCount=(p._poolUseCount||0)+1,this.emit("release",w,p),w||this.ending||!p._queryable||p._ending||p._poolUseCount>=this.options.maxUses){p._poolUseCount>=this.options.maxUses&&this.log("remove expended client"),this._remove(p),this._pulseQueue();return}if(this._expired.has(p)){this.log("remove expired client"),this._expired.delete(p),this._remove(p),this._pulseQueue();return}let S;this.options.idleTimeoutMillis&&(S=setTimeout(()=>{this.log("remove idle client"),this._remove(p)},this.options.idleTimeoutMillis),this.options.allowExitOnIdle&&S.unref()),this.options.allowExitOnIdle&&p.unref(),this._idle.push(new s(p,y,S)),this._pulseQueue()}query(p,y,w){if(typeof p=="function"){let _=u(this.Promise,p);return xf(function(){return _.callback(new Error("Passing a function as the first parameter to pool.query is not supported"))}),_.result}typeof y=="function"&&(w=y,y=void 0);let S=u(this.Promise,w);return w=S.callback,this.connect((_,O)=>{if(_)return w(_);let q=!1,k=x(A=>{q||(q=!0,O.release(A),w(A))},"onError");O.once("error",k),this.log("dispatching query");try{O.query(p,y,(A,I)=>{if(this.log("query dispatched"),O.removeListener("error",k),!q)return q=!0,O.release(A),A?w(A):w(void 0,I)})}catch(A){return O.release(A),w(A)}}),S.result}end(p){if(this.log("ending"),this.ending){let w=new Error("Called end on pool more than once");return p?p(w):this.Promise.reject(w)}this.ending=!0;let y=u(this.Promise,p);return this._endCallback=y.callback,this._pulseQueue(),y.result}get waitingCount(){return this._pendingQueue.length}get idleCount(){return this._idle.length}get expiredCount(){return this._clients.reduce((p,y)=>p+(this._expired.has(y)?1:0),0)}get totalCount(){return this._clients.length}};x(m,"Pool");var g=m;e.exports=g}),Fw={};ar(Fw,{default:()=>Uw});var Uw,ZI=Lt(()=>{"use strict";te(),Uw={}}),XI=fe((t,e)=>{e.exports={name:"pg",version:"8.8.0",description:"PostgreSQL client - pure javascript & libpq with the same API",keywords:["database","libpq","pg","postgre","postgres","postgresql","rdbms"],homepage:"https://github.com/brianc/node-postgres",repository:{type:"git",url:"git://github.com/brianc/node-postgres.git",directory:"packages/pg"},author:"Brian Carlson <brian.m.carlson@gmail.com>",main:"./lib",dependencies:{"buffer-writer":"2.0.0","packet-reader":"1.0.0","pg-connection-string":"^2.5.0","pg-pool":"^3.5.2","pg-protocol":"^1.5.0","pg-types":"^2.1.0",pgpass:"1.x"},devDependencies:{async:"2.6.4",bluebird:"3.5.2",co:"4.6.0","pg-copy-streams":"0.3.0"},peerDependencies:{"pg-native":">=3.0.1"},peerDependenciesMeta:{"pg-native":{optional:!0}},scripts:{test:"make test-all"},files:["lib","SPONSORS.md"],license:"MIT",engines:{node:">= 8.0.0"},gitHead:"c99fb2c127ddf8d712500db2c7b9a5491a178655"}}),YI=fe((t,e)=>{"use strict";te();var r=Kn().EventEmitter,n=(Bc(),lt(Os)),i=Fc(),a=e.exports=function(o,c,l){r.call(this),o=i.normalizeQueryConfig(o,c,l),this.text=o.text,this.values=o.values,this.name=o.name,this.callback=o.callback,this.state="new",this._arrayMode=o.rowMode==="array",this._emitRowEvents=!1,this.on("newListener",function(u){u==="row"&&(this._emitRowEvents=!0)}.bind(this))};n.inherits(a,r);var s={sqlState:"code",statementPosition:"position",messagePrimary:"message",context:"where",schemaName:"schema",tableName:"table",columnName:"column",dataTypeName:"dataType",constraintName:"constraint",sourceFile:"file",sourceLine:"line",sourceFunction:"routine"};a.prototype.handleError=function(o){var c=this.native.pq.resultErrorFields();if(c)for(var l in c){var u=s[l]||l;o[u]=c[l]}this.callback?this.callback(o):this.emit("error",o),this.state="error"},a.prototype.then=function(o,c){return this._getPromise().then(o,c)},a.prototype.catch=function(o){return this._getPromise().catch(o)},a.prototype._getPromise=function(){return this._promise?this._promise:(this._promise=new Promise(function(o,c){this._once("end",o),this._once("error",c)}.bind(this)),this._promise)},a.prototype.submit=function(o){this.state="running";var c=this;this.native=o.native,o.native.arrayMode=this._arrayMode;var l=x(function(m,g,h){if(o.native.arrayMode=!1,xf(function(){c.emit("_done")}),m)return c.handleError(m);c._emitRowEvents&&(h.length>1?g.forEach((p,y)=>{p.forEach(w=>{c.emit("row",w,h[y])})}):g.forEach(function(p){c.emit("row",p,h)})),c.state="end",c.emit("end",h),c.callback&&c.callback(null,h)},"after");if(de.domain&&(l=de.domain.bind(l)),this.name){this.name.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",this.name,this.name.length),console.error("This can cause conflicts and silent errors executing queries"));var u=(this.values||[]).map(i.prepareValue);if(o.namedQueries[this.name]){if(this.text&&o.namedQueries[this.name]!==this.text){let m=new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`);return l(m)}return o.native.execute(this.name,u,l)}return o.native.prepare(this.name,this.text,u.length,function(m){return m?l(m):(o.namedQueries[c.name]=c.text,c.native.execute(c.name,u,l))})}else if(this.values){if(!Array.isArray(this.values)){let m=new Error("Query values must be an array");return l(m)}var d=this.values.map(i.prepareValue);o.native.query(this.text,d,l)}else o.native.query(this.text,l)}}),JI=fe((t,e)=>{"use strict";te();var r=(ZI(),lt(Fw)),n=Ef(),i=XI(),a=Kn().EventEmitter,s=(Bc(),lt(Os)),o=Cf(),c=YI(),l=e.exports=function(u){a.call(this),u=u||{},this._Promise=u.Promise||Mc.Promise,this._types=new n(u.types),this.native=new r({types:this._types}),this._queryQueue=[],this._ending=!1,this._connecting=!1,this._connected=!1,this._queryable=!0;var d=this.connectionParameters=new o(u);this.user=d.user,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:d.password}),this.database=d.database,this.host=d.host,this.port=d.port,this.namedQueries={}};l.Query=c,s.inherits(l,a),l.prototype._errorAllQueries=function(u){let d=x(m=>{de.nextTick(()=>{m.native=this.native,m.handleError(u)})},"enqueueError");this._hasActiveQuery()&&(d(this._activeQuery),this._activeQuery=null),this._queryQueue.forEach(d),this._queryQueue.length=0},l.prototype._connect=function(u){var d=this;if(this._connecting){de.nextTick(()=>u(new Error("Client has already been connected. You cannot reuse a client.")));return}this._connecting=!0,this.connectionParameters.getLibpqConnectionString(function(m,g){if(m)return u(m);d.native.connect(g,function(h){if(h)return d.native.end(),u(h);d._connected=!0,d.native.on("error",function(p){d._queryable=!1,d._errorAllQueries(p),d.emit("error",p)}),d.native.on("notification",function(p){d.emit("notification",{channel:p.relname,payload:p.extra})}),d.emit("connect"),d._pulseQueryQueue(!0),u()})})},l.prototype.connect=function(u){if(u){this._connect(u);return}return new this._Promise((d,m)=>{this._connect(g=>{g?m(g):d()})})},l.prototype.query=function(u,d,m){var g,h,p,y,w;if(u==null)throw new TypeError("Client was passed a null or undefined query");if(typeof u.submit=="function")p=u.query_timeout||this.connectionParameters.query_timeout,h=g=u,typeof d=="function"&&(u.callback=d);else if(p=this.connectionParameters.query_timeout,g=new c(u,d,m),!g.callback){let S,_;h=new this._Promise((O,q)=>{S=O,_=q}),g.callback=(O,q)=>O?_(O):S(q)}return p&&(w=g.callback,y=setTimeout(()=>{var S=new Error("Query read timeout");de.nextTick(()=>{g.handleError(S,this.connection)}),w(S),g.callback=()=>{};var _=this._queryQueue.indexOf(g);_>-1&&this._queryQueue.splice(_,1),this._pulseQueryQueue()},p),g.callback=(S,_)=>{clearTimeout(y),w(S,_)}),this._queryable?this._ending?(g.native=this.native,de.nextTick(()=>{g.handleError(new Error("Client was closed and is not queryable"))}),h):(this._queryQueue.push(g),this._pulseQueryQueue(),h):(g.native=this.native,de.nextTick(()=>{g.handleError(new Error("Client has encountered a connection error and is not queryable"))}),h)},l.prototype.end=function(u){var d=this;this._ending=!0,this._connected||this.once("connect",this.end.bind(this,u));var m;return u||(m=new this._Promise(function(g,h){u=x(p=>p?h(p):g(),"cb")})),this.native.end(function(){d._errorAllQueries(new Error("Connection terminated")),de.nextTick(()=>{d.emit("end"),u&&u()})}),m},l.prototype._hasActiveQuery=function(){return this._activeQuery&&this._activeQuery.state!=="error"&&this._activeQuery.state!=="end"},l.prototype._pulseQueryQueue=function(u){if(this._connected&&!this._hasActiveQuery()){var d=this._queryQueue.shift();if(!d){u||this.emit("drain");return}this._activeQuery=d,d.submit(this);var m=this;d.once("_done",function(){m._pulseQueryQueue()})}},l.prototype.cancel=function(u){this._activeQuery===u?this.native.cancel(function(){}):this._queryQueue.indexOf(u)!==-1&&this._queryQueue.splice(this._queryQueue.indexOf(u),1)},l.prototype.ref=function(){},l.prototype.unref=function(){},l.prototype.setTypeParser=function(u,d,m){return this._types.setTypeParser(u,d,m)},l.prototype.getTypeParser=function(u,d){return this._types.getTypeParser(u,d)}}),pw=fe((t,e)=>{"use strict";te(),e.exports=JI()}),Pf=fe((t,e)=>{"use strict";te();var r=WI(),n=$c(),i=$w(),a=KI(),{DatabaseError:s}=Mw(),o=x(l=>{var u;return u=class extends a{constructor(d){super(d,l)}},x(u,"BoundPool"),u},"poolFactory"),c=x(function(l){this.defaults=n,this.Client=l,this.Query=this.Client.Query,this.Pool=o(this.Client),this._pools=[],this.Connection=i,this.types=Dc(),this.DatabaseError=s},"PG");typeof de.env.NODE_PG_FORCE_NATIVE<"u"?e.exports=new c(pw()):(e.exports=new c(r),Object.defineProperty(e.exports,"native",{configurable:!0,enumerable:!1,get(){var l=null;try{l=new c(pw())}catch(u){if(u.code!=="MODULE_NOT_FOUND")throw u}return Object.defineProperty(e.exports,"native",{value:l}),l}}))});te();var zw=na(Pf());Af();te();Af();qw();var e9=na(Fc()),t9=na(Ef());function Qw(t){return t instanceof se?"\\x"+t.toString("hex"):t}x(Qw,"encodeBuffersAsBytea");var Vw=class Gw extends Error{constructor(e){super(e),ce(this,"name","NeonDbError"),ce(this,"severity"),ce(this,"code"),ce(this,"detail"),ce(this,"hint"),ce(this,"position"),ce(this,"internalPosition"),ce(this,"internalQuery"),ce(this,"where"),ce(this,"schema"),ce(this,"table"),ce(this,"column"),ce(this,"dataType"),ce(this,"constraint"),ce(this,"file"),ce(this,"line"),ce(this,"routine"),ce(this,"sourceError"),"captureStackTrace"in Error&&typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Gw)}};x(Vw,"NeonDbError");var ta=Vw,dw="transaction() expects an array of queries, or a function returning an array of queries",r9=["severity","code","detail","hint","position","internalPosition","internalQuery","where","schema","table","column","dataType","constraint","file","line","routine"];function Hw(t,{arrayMode:e,fullResults:r,fetchOptions:n,isolationLevel:i,readOnly:a,deferrable:s,queryCallback:o,resultCallback:c,authToken:l}={}){if(!t)throw new Error("No database connection string was provided to `neon()`. Perhaps an environment variable has not been set?");let u;try{u=Tf(t)}catch{throw new Error("Database connection string provided to `neon()` is not a valid URL. Connection string: "+String(t))}let{protocol:d,username:m,hostname:g,port:h,pathname:p}=u;if(d!=="postgres:"&&d!=="postgresql:"||!m||!g||!p)throw new Error("Database connection string format for `neon()` should be: postgresql://user:password@host.tld/dbname?option=value");function y(S,..._){let O,q;if(typeof S=="string")O=S,q=_[1],_=_[0]??[];else{O="";for(let A=0;A<S.length;A++)O+=S[A],A<_.length&&(O+="$"+(A+1))}_=_.map(A=>Qw((0,e9.prepareValue)(A)));let k={query:O,params:_};return o&&o(k),Ww(w,k,q)}x(y,"resolve"),y.transaction=async(S,_)=>{if(typeof S=="function"&&(S=S(y)),!Array.isArray(S))throw new Error(dw);S.forEach(k=>{if(k[Symbol.toStringTag]!=="NeonQueryPromise")throw new Error(dw)});let O=S.map(k=>k.parameterizedQuery),q=S.map(k=>k.opts??{});return w(O,q,_)};async function w(S,_,O){let{fetchEndpoint:q,fetchFunction:k}=cn,A=Array.isArray(S)?{queries:S}:S,I=n??{},T=e??!1,M=r??!1,B=i,W=a,V=s;O!==void 0&&(O.fetchOptions!==void 0&&(I={...I,...O.fetchOptions}),O.arrayMode!==void 0&&(T=O.arrayMode),O.fullResults!==void 0&&(M=O.fullResults),O.isolationLevel!==void 0&&(B=O.isolationLevel),O.readOnly!==void 0&&(W=O.readOnly),O.deferrable!==void 0&&(V=O.deferrable)),_!==void 0&&!Array.isArray(_)&&_.fetchOptions!==void 0&&(I={...I,..._.fetchOptions});let L=l;!Array.isArray(_)&&_?.authToken!==void 0&&(L=_.authToken);let U=typeof q=="function"?q(g,h,{jwtAuth:L!==void 0}):q,J={"Neon-Connection-String":t,"Neon-Raw-Text-Output":"true","Neon-Array-Mode":"true"},ie=await Kw(L);ie&&(J.Authorization=`Bearer ${ie}`),Array.isArray(S)&&(B!==void 0&&(J["Neon-Batch-Isolation-Level"]=B),W!==void 0&&(J["Neon-Batch-Read-Only"]=String(W)),V!==void 0&&(J["Neon-Batch-Deferrable"]=String(V)));let ye;try{ye=await(k??fetch)(U,{method:"POST",body:JSON.stringify(A),headers:J,...I})}catch(be){let Fe=new ta(`Error connecting to database: ${be.message}`);throw Fe.sourceError=be,Fe}if(ye.ok){let be=await ye.json();if(Array.isArray(S)){let Fe=be.results;if(!Array.isArray(Fe))throw new ta("Neon internal error: unexpected result format");return Fe.map((qe,Ue)=>{let pn=_[Ue]??{},fa=pn.arrayMode??T,ma=pn.fullResults??M;return bf(qe,{arrayMode:fa,fullResults:ma,parameterizedQuery:S[Ue],resultCallback:c,types:pn.types})})}else{let Fe=_??{},qe=Fe.arrayMode??T,Ue=Fe.fullResults??M;return bf(be,{arrayMode:qe,fullResults:Ue,parameterizedQuery:S,resultCallback:c,types:Fe.types})}}else{let{status:be}=ye;if(be===400){let Fe=await ye.json(),qe=new ta(Fe.message);for(let Ue of r9)qe[Ue]=Fe[Ue]??void 0;throw qe}else{let Fe=await ye.text();throw new ta(`Server error (HTTP status ${be}): ${Fe}`)}}}return x(w,"execute"),y}x(Hw,"neon");function Ww(t,e,r){return{[Symbol.toStringTag]:"NeonQueryPromise",parameterizedQuery:e,opts:r,then:x((n,i)=>t(e,r).then(n,i),"then"),catch:x(n=>t(e,r).catch(n),"catch"),finally:x(n=>t(e,r).finally(n),"finally")}}x(Ww,"createNeonQueryPromise");function bf(t,{arrayMode:e,fullResults:r,parameterizedQuery:n,resultCallback:i,types:a}){let s=new t9.default(a),o=t.fields.map(u=>u.name),c=t.fields.map(u=>s.getTypeParser(u.dataTypeID)),l=e===!0?t.rows.map(u=>u.map((d,m)=>d===null?null:c[m](d))):t.rows.map(u=>Object.fromEntries(u.map((d,m)=>[o[m],d===null?null:c[m](d)])));return i&&i(n,t,l,{arrayMode:e,fullResults:r}),r?(t.viaNeonFetch=!0,t.rowAsArray=e,t.rows=l,t._parsers=c,t._types=s,t):l}x(bf,"processQueryResult");async function Kw(t){if(typeof t=="string")return t;if(typeof t=="function")try{return await Promise.resolve(t())}catch(e){let r=new ta("Error getting auth token.");throw e instanceof Error&&(r=new ta(`Error getting auth token: ${e.message}`)),r}}x(Kw,"getAuthToken");var n9=na(Cf()),ia=na(Pf()),Zw=class extends zw.Client{constructor(e){super(e),this.config=e}get neonConfig(){return this.connection.stream}connect(e){let{neonConfig:r}=this;r.forceDisablePgSSL&&(thisnpm warn config production Use `--omit=dev` instead.
> rest-express@1.0.0 start
> NODE_ENV=production node dist/index.cjs
/app/dist/index.cjs:78